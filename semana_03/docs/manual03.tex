\documentclass[11pt, a4paper]{article}

% --- MOTOR DE FUENTES (XeLaTeX) ---
\usepackage{fontspec}
\setmainfont{DejaVu Sans}[
    BoldFont={DejaVu Sans Bold},
    ItalicFont={DejaVu Sans Oblique},
    Scale=0.9
]
\setmonofont{DejaVu Sans Mono}[Scale=0.8]

% --- IDIOMA ---
\usepackage{polyglossia}
\setmainlanguage{spanish}

% --- PAQUETES ---
\usepackage{geometry}
\usepackage{xcolor}
\usepackage{listings}
\usepackage[most]{tcolorbox}
\usepackage{booktabs}
\usepackage{hyperref}
\usepackage{graphicx}
\usepackage{fancyhdr}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{tikz}
\usepackage{colortbl}
\usetikzlibrary{shapes, arrows, positioning, babel, matrix, backgrounds}

% --- GEOMETR칈A ---
\geometry{top=2.5cm, bottom=2.5cm, left=2.5cm, right=2.5cm}
\setlength{\headheight}{28pt}
\setlength{\parskip}{0.5em}

% --- COLORES ---
\definecolor{primary}{RGB}{0, 85, 164}      % Azul Ingenier칤a
\definecolor{accent}{RGB}{34, 139, 34}      % Verde Agro
\definecolor{danger}{RGB}{204, 0, 0}        % Rojo Alerta
\definecolor{pandas}{RGB}{19, 7, 84}        % Azul oscuro (Pandas)
\definecolor{codebg}{RGB}{245, 247, 250}

% --- CAJAS PERSONALIZADAS (CORREGIDAS) ---
\newtcolorbox{conceptbox}[1]{
  colback=blue!5!white, colframe=primary, title=#1, fonttitle=\bfseries,
  boxrule=0.5mm, arc=2mm, shadow={2mm}{-2mm}{0mm}{black!20}
}

% FIX: El emoji ahora es parte del titulo, no un parametro 'icon'
\newtcolorbox{agrobox}[1]{
  colback=green!5!white, colframe=accent,
  title=\textbf{游꺔} #1,
  fonttitle=\bfseries,
  boxrule=0.5mm, arc=2mm
}

\newtcolorbox{warningbox}[1]{
  colback=red!5!white, colframe=danger, title=#1, fonttitle=\bfseries,
  boxrule=0.5mm, arc=2mm
}

\newtcolorbox{ethicsbox}[1]{
  colback=yellow!5!white, colframe=orange!75!black, title=#1, fonttitle=\bfseries,
  boxrule=0.5mm, arc=2mm
}

% --- ESTILO DE C칍DIGO ---
\lstdefinestyle{pythonstyle}{
    backgroundcolor=\color{codebg},
    commentstyle=\color{gray}\itshape,
    keywordstyle=\color{pandas}\bfseries,
    numberstyle=\tiny\color{gray},
    stringstyle=\color{accent},
    basicstyle=\ttfamily\footnotesize,
    breaklines=true,
    frame=l,
    rulecolor=\color{pandas},
    numbers=left,
    showstringspaces=false,
    literate=
    {치}{{\'a}}1 {칠}{{\'e}}1 {칤}{{\'i}}1 {칩}{{\'o}}1 {칰}{{\'u}}1 {침}{{\~n}}1
    {丘맣{{\textcolor{orange}{\bfseries !}}}1
    {NaN}{{\textcolor{red}{\bfseries NaN}}}3
    {None}{{\textcolor{red}{\bfseries None}}}4
}
\lstset{style=pythonstyle}

% --- ENCABEZADO ---
\pagestyle{fancy}
\fancyhf{}
\lhead{\textbf{Ingenier칤a de Software I}}
\rhead{M칩dulo 2: Ciencia de Datos}
\rfoot{P치gina \thepage}

\title{\textbf{Manual Avanzado de Pandas}\\ Procesamiento de Datos para Agroindustria 4.0}
\author{Curso de IA Aplicada al Agro}
\date{\today}

\begin{document}

\maketitle
\tableofcontents
\newpage

\section*{Introducci칩n: La Estructura de los Datos}

Antes de limpiar datos, debemos entender c칩mo Pandas los organiza en la memoria RAM. A diferencia de Excel, donde todo es una celda visual, Pandas distingue rigurosamente entre tipos de estructuras.

\begin{center}
\begin{tikzpicture}[node distance=2cm]
    % Series
    \node (series) [draw=accent, fill=green!5, rectangle, rounded corners, minimum width=3cm, minimum height=3cm, align=center] {
        \textbf{Series (1D)}\\
        \textit{"Una Columna"}\\
        \rule{2.5cm}{0.5pt}\\
        0: 25.4\\
        1: 26.1\\
        2: 24.8\\
        ...\\
        \textit{Un solo tipo de dato}
    };

    % DataFrame
    \node (df) [draw=pandas, fill=blue!5, rectangle, rounded corners, minimum width=5cm, minimum height=3cm, right=of series, align=center] {
        \textbf{DataFrame (2D)}\\
        \textit{"Una Tabla"}\\
        \rule{4.5cm}{0.5pt}\\
        Colecci칩n de Series\\
        compartiendo un 칤ndice.\\
        \textit{Columnas heterog칠neas}\\
        (Int, Float, String, Datetime)
    };

    \draw[->, ultra thick, gray] (series) -- (df) node[midway, above] {\footnotesize Se agrupan en};
\end{tikzpicture}
\end{center}

\section{Cap칤tulo I: Ingesta de Datos (I/O)}

El mundo real no vive solo en CSV. En agroindustria, lidiar치s con Excel antiguos y JSON de APIs modernas.

\subsection{Lectura Robusta}
El comando \texttt{read\_csv} tiene m치s de 50 par치metros. Aqu칤 est치n los esenciales para evitar errores al cargar.

\begin{lstlisting}[language=Python, caption={Carga Avanzada de Datos}]
import pandas as pd

# 1. Cargar CSV definiendo fechas y nulos personalizados
df_sensor = pd.read_csv(
    'sensores_raw.csv',
    sep=';',                    # A veces usan punto y coma
    parse_dates=['fecha_hora'], # Convertir autom. a datetime
    na_values=['error', '-', 'null'], # Tratar estos textos como NaN
    dtype={'id_sensor': str}    # Forzar ID como texto, no numero
)

# 2. Cargar Excel (requiere libreria 'openpyxl')
df_suelos = pd.read_excel(
    'analisis_suelos.xlsx',
    sheet_name='Lote_Norte',
    header=1  # Usar la segunda fila como titulos
)
\end{lstlisting}

\subsection{Inspecci칩n Inicial}
Lo primero que haces al recibir un dataset:

\begin{lstlisting}[language=Python]
print(df.shape)   # (filas, columnas)
print(df.dtypes)  # 쯃os numeros son float o object (texto)?
print(df.head(3)) # Muestra visual rapida
print(df['cultivo'].value_counts()) # Conteo de categorias unicas
\end{lstlisting}

\newpage

\section{Cap칤tulo II: Indexaci칩n y Selecci칩n Quir칰rgica}

Acceder a los datos incorrectamente es la fuente \#1 de \textit{bugs} silenciosos.

\begin{table}[h]
\centering
\rowcolors{2}{gray!10}{white}
\begin{tabular}{l p{6cm} p{6cm}}
\toprule
\textbf{M칠todo} & \textbf{쯈u칠 usa?} & \textbf{Ejemplo} \\
\midrule
\texttt{.loc[]} & \textbf{Etiquetas} (Nombres) & \texttt{df.loc["2024-01-01", "Humedad"]} \\
\texttt{.iloc[]} & \textbf{Posici칩n} (Enteros) & \texttt{df.iloc[0, 3]} \\
\texttt{df[ ]} & \textbf{Columnas} (Principalmente) & \texttt{df["Temperatura"]} \\
\bottomrule
\end{tabular}
\end{table}

\subsection{Filtrado Booleano (M치scaras)}
No uses \texttt{if} dentro de un \texttt{for}. Usa m치scaras vectorizadas.

\begin{lstlisting}[language=Python, caption={Consultas Complejas}]
# 1. Crear la mascara (devuelve Series de True/False)
mask_calor = df['Temperatura'] > 30
mask_seco  = df['Humedad'] < 40

# 2. Aplicar filtro
alerta_estres = df[mask_calor & mask_seco]

# 3. Filtrar por lista de valores permitidos
lotes_interes = ['Lote_A1', 'Lote_B5']
df_foco = df[df['id_lote'].isin(lotes_interes)]
\end{lstlisting}

\section{Cap칤tulo III: Limpieza Profunda (Data Cleaning)}

\begin{warningbox}{Tipos de Datos Incorrectos}
Si una columna de n칰meros tiene un solo texto (ej: "Sin dato"), Pandas convertir치 \textbf{toda} la columna a \texttt{object} (texto). No podr치s hacer sumas ni promedios.
\end{warningbox}

\subsection{Sanitizaci칩n de Tipos}
\begin{lstlisting}[language=Python]
# Convertir a numerico, forzando errores a NaN
# Si hay un texto "Error", se vuelve NaN en lugar de romper el codigo
df['ph_suelo'] = pd.to_numeric(df['ph_suelo'], errors='coerce')

# Eliminar duplicados (ej: sensor envio el dato 2 veces)
df = df.drop_duplicates(subset=['fecha', 'id_sensor'])
\end{lstlisting}

\subsection{Tratamiento de Nulos (Imputaci칩n)}
\begin{itemize}
    \item \texttt{fillna(0)}: Peligroso en agro (0 de lluvia es v치lido, 0 de pH es 치cido mortal).
    \item \texttt{ffill()}: Rellenar con el 칰ltimo valor conocido (ideal sensores).
    \item \texttt{interpolate()}: Trazar una l칤nea entre puntos.
\end{itemize}

\begin{lstlisting}[language=Python]
# Interpolacion lineal limitada a huecos peque침os
df['Humedad'] = df['Humedad'].interpolate(method='time', limit=2)
\end{lstlisting}

\newpage

\section{Cap칤tulo IV: Ingenier칤a de Caracter칤sticas}

La IA no aprende sola; a veces debemos darle "pistas" creando nuevas columnas.

\subsection{Operaciones Vectorizadas}
\begin{lstlisting}[language=Python]
# Crear columna nueva basada en calculo matematico
# Diferencia de temperatura (Dia - Noche)
df['amplitud_termica'] = df['temp_max'] - df['temp_min']
\end{lstlisting}

\subsection{L칩gica Personalizada (.apply)}
Cuando la matem치tica simple no basta, aplicamos una funci칩n a cada fila. **Nota:** Es m치s lento que vectorizar, 칰salo con cuidado.

\begin{lstlisting}[language=Python]
def clasificar_riesgo(fila):
    if fila['Humedad'] > 90 and fila['Temperatura'] > 25:
        return "ALTO (Hongos)"
    elif fila['Viento'] > 50:
        return "ALTO (Da침o Fisico)"
    else:
        return "BAJO"

# axis=1 significa "pasar la fila completa a la funcion"
df['tipo_riesgo'] = df.apply(clasificar_riesgo, axis=1)
\end{lstlisting}

\section{Cap칤tulo V: Series Temporales y Resampling}

El agro se mueve por ciclos (diarios, mensuales, estacionales).

\begin{conceptbox}{Resampling vs Rolling}
\begin{itemize}
    \item \textbf{Resample:} Cambiar la frecuencia (de Hora $\rightarrow$ D칤a). Como un "Zoom Out".
    \item \textbf{Rolling:} Ventana deslizante. Suaviza el gr치fico manteniendo la frecuencia.
\end{itemize}
\end{conceptbox}

\begin{lstlisting}[language=Python, caption={An치lisis Temporal}]
# Asegurar que el indice es Datetime
df = df.set_index('fecha')

# 1. RESAMPLE: Promedio Mensual ('M')
clima_mensual = df.resample('M').mean()

# 2. ROLLING: Media movil de 7 dias (Suavizar picos)
# Elimina el ruido de dias atipicos
df['temp_suavizada'] = df['Temperatura'].rolling(window=7).mean()
\end{lstlisting}

\section{Cap칤tulo VI: Fusi칩n de Datos (Merge)}

Rara vez tienes toda la info en una tabla.
\begin{itemize}
    \item Tabla A: Cosecha (kilos, fecha, \texttt{id\_lote})
    \item Tabla B: Suelo (\texttt{id\_lote}, \texttt{tipo\_tierra}, ph)
\end{itemize}

\begin{lstlisting}[language=Python]
# Unir tablas usando 'id_lote' como llave
# how='left' mantiene todas las cosechas, y pega info de suelo si existe
df_completo = pd.merge(
    df_cosecha,
    df_suelo,
    on='id_lote',
    how='left'
)
\end{lstlisting}

\newpage

\section{Cap칤tulo VII: 칄tica y Documentaci칩n}

La limpieza de datos es un proceso subjetivo que altera la realidad observada.

\begin{ethicsbox}{Checklist de Integridad de Datos}
\begin{enumerate}
    \item \textbf{Trazabilidad:} 쮾uardo el dataset \texttt{raw} original sin tocar?
    \item \textbf{Transparencia:} 쮻ocumento cu치ntas filas elimin칠 y por qu칠?
    \item \textbf{Sesgo de Imputaci칩n:} Al rellenar nulos con el promedio, 쯘stoy ocultando un fallo sistem치tico de un sensor en una zona pobre?
\end{enumerate}
\end{ethicsbox}

\section*{Reto Profesional: Auditor칤a Clim치tica}

Se te entrega \texttt{estacion\_falla.csv} (10,000 filas). Contiene datos horarios de 2023.

\textbf{Problemas conocidos:}
\begin{enumerate}
    \item El sensor de lluvia se "traba" y repite el valor exacto por horas.
    \item Hay temperaturas de $200^\circ$C (error de voltaje).
    \item Faltan d칤as completos en Octubre.
\end{enumerate}

\textbf{Tu Misi칩n:}
\begin{lstlisting}[language=Python]
# 1. Cargar parseando fechas
df = pd.read_csv('estacion_falla.csv', parse_dates=['timestamp'], index_col='timestamp')

# 2. Filtrar Outliers (Temp > 50 es imposible)
df.loc[df['temp'] > 50, 'temp'] = pd.NA

# 3. Detectar "valores congelados" (Diff = 0 por mucho tiempo)
# shift(1) mueve la columna un paso abajo para comparar con la anterior
df['cambio_lluvia'] = df['lluvia'] - df['lluvia'].shift(1)

# 4. Resamplear a diario sumando lluvia y promediando temp
df_diario = df.resample('D').agg({
    'lluvia': 'sum',
    'temp': 'mean',
    'humedad': 'max'
})

# 5. Visualizar comparando Raw vs Limpio
import matplotlib.pyplot as plt
plt.figure(figsize=(12,6))
df['temp'].plot(alpha=0.3, label='Raw (Horario)', color='gray')
df_diario['temp'].plot(linewidth=2, label='Limpio (Diario)', color='blue')
plt.legend()
plt.title("Auditoria de Temperatura 2023")
plt.savefig("reporte_calidad.pdf")
\end{lstlisting}

\newpage

\section{Cap칤tulo VIII: Taller de Ejercicios Pr치cticos}

La 칰nica forma de aprender Pandas es escribiendo c칩digo. En este cap칤tulo, resolveremos problemas reales de la agroindustria.

\subsection{Nivel 1: Laboratorio Guiado (Producci칩n Lechera)}
En este ejercicio, crearemos un peque침o dataset manualmente para entender el flujo completo sin depender de archivos externos.

\begin{agrobox}{Objetivo}
Analizar la calidad de leche de 3 vacas durante una semana y detectar anomal칤as en el pH (Rango normal: 6.6 - 6.8).
\end{agrobox}

\begin{lstlisting}[language=Python, caption={Simulaci칩n y An치lisis}]
import pandas as pd
import numpy as np

# 1. CREAR DATOS SIMULADOS
data = {
    'id_vaca': ['V01', 'V02', 'V01', 'V03', 'V02', 'V03'],
    'fecha': ['2024-01-01', '2024-01-01', '2024-01-02',
              '2024-01-01', '2024-01-02', '2024-01-02'],
    'litros': [20.5, 18.2, 21.0, 19.5, 18.0, 15.0],
    'ph': [6.7, 6.6, 6.2, 6.8, 6.9, 7.1] # Notar valores acidos/alcalinos
}

df_leche = pd.DataFrame(data)

# 2. LIMPIEZA: FILTRAR LECHE ACIDA (pH < 6.5)
# Esto se descarta para consumo humano
leche_mala = df_leche[df_leche['ph'] < 6.5]
print("--- ALERTA DE ACIDEZ ---")
print(leche_mala)

# 3. ANALISIS: TOTAL DE LITROS POR VACA (SOLO LECHE BUENA)
df_buena = df_leche[df_leche['ph'] >= 6.5]
reporte = df_buena.groupby('id_vaca')['litros'].sum()

print("\n--- REPORTE DE PAGO ---")
print(reporte)
\end{lstlisting}

\subsection{Nivel 2: Ejercicios de Calistenia}
Resuelve estos problemas cortos. Asume que tienes un DataFrame llamado \texttt{df\_clima}.

\begin{itemize}
    \item \textbf{Ejercicio A (Selecci칩n):} Crea un nuevo DataFrame llamado \texttt{df\_lluvia} que solo contenga las columnas \texttt{"fecha"} y \texttt{"precipitacion"}.
    \item \textbf{Ejercicio B (Filtro Simple):} Filtra los d칤as donde la \texttt{"temperatura"} fue mayor a 35 grados.
    \item \textbf{Ejercicio C (Correcci칩n de Texto):} La columna \texttt{"zona"} tiene valores " Norte" (con espacio extra). Usa \texttt{df['zona'].str.strip()} para arreglarlo.
    \item \textbf{Ejercicio D (Creaci칩n de Columnas):} Convierte la temperatura de Celsius a Fahrenheit en una nueva columna: $F = C \times 1.8 + 32$.
\end{itemize}

\subsection{Nivel 3: El Desaf칤o de Integraci칩n}

\begin{warningbox}{Escenario Real}
Tienes dos fuentes de datos no sincronizadas:
\begin{enumerate}
    \item \texttt{ventas.csv}: Registro de sacos de caf칠 vendidos (con fechas).
    \item \texttt{precio\_internacional.csv}: Precio del caf칠 en bolsa (diario).
\end{enumerate}
\textbf{Problema:} El archivo de ventas no tiene el precio. Debes cruzar los datos para saber cu치nto dinero real ingres칩.
\end{warningbox}

\textbf{Pasos para la soluci칩n:}

\begin{lstlisting}[language=Python]
# PISTA PARA LA SOLUCION

# 1. Cargar ambos DataFrames
ventas = pd.read_csv('ventas.csv')
precios = pd.read_csv('precio_internacional.csv')

# 2. Asegurar que las fechas sean tipo 'datetime' en AMBOS
ventas['fecha'] = pd.to_datetime(ventas['fecha'])
precios['fecha'] = pd.to_datetime(precios['fecha'])

# 3. Realizar el MERGE (Cruce)
# Usamos 'left' para no perder ventas si falta algun precio
df_final = pd.merge(ventas, precios, on='fecha', how='left')

# 4. Calcular ingreso total
# Si faltan precios (NaN), rellenar con el promedio antes de calcular
precio_promedio = precios['valor'].mean()
df_final['valor'] = df_final['valor'].fillna(precio_promedio)

df_final['ingreso_total'] = df_final['kilos_vendidos'] * df_final['valor']
\end{lstlisting}

\begin{conceptbox}{쯇or qu칠 fallan los Merges?}
El error m치s com칰n es que la columna clave (\texttt{fecha}) tenga formatos distintos.
\begin{itemize}
    \item Tabla A: "2024-01-01" (String)
    \item Tabla B: 2024-01-01 (Timestamp)
\end{itemize}
\textbf{Regla de Oro:} Siempre normaliza tipos con \texttt{.info()} antes de unir tablas.
\end{conceptbox}

\end{document}